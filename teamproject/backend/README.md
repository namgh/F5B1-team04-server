# CU2 project

#### project ê¸°ê°„ : 3/17 ~ 4/4

#### ëª©ì°¨
1. ê¸°íšì˜ë„
2. ì‚¬ìš©ê¸°ìˆ  ìŠ¤íƒ
3. ë°ì´í„° íë¦„ë„
4. data flow
5. erd
6. apiëª…ì„¸ì„œ
7. api
### 1. ê¸°íšì˜ë„

ì´ˆë³´ ê°œë°œìì˜ Self Study Solutionì„ ì œê³µí•˜ëŠ” CU2 ì…ë‹ˆë‹¤.
CU2ëŠ” ì»¤ë®¤ë‹ˆí‹° ì„œë¹„ìŠ¤ CodingUs ì™€ ë©˜í† ë§ ì„œë¹„ìŠ¤ CoachingUs ë¡œ Self Study Solutionì„ ì œê³µí•˜ì—¬ ì´ˆë³´ ê°œë°œìë¥¼ ì„±ì¥ì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì•ì„œ CU2 ì„œë¹„ìŠ¤ ì´ìš©ìëŠ” Usë¡œ ë¶ˆë¦¬ë©° UsMember(ì¼ë°˜ ìœ ì €)ì™€ UsCoach(ì½”ì¹˜ ìœ ì €)ë¡œ ë‚˜ëˆ ì§‘ë‹ˆë‹¤.

â€˜ë‚´ê°€ ì˜ í•˜ê³  ìˆëŠ”ê±´ê°€?â€™ë¥¼ ì§€ì†ì ìœ¼ë¡œ í™•ì¸í•  ìˆ˜ ìˆë„ë¡ CU2ì˜ ëª¨ë“  í™œë™ì—ëŠ” ì ìˆ˜ê°€ ë¶€ì—¬ë©ë‹ˆë‹¤. CodingUsì—ì„œëŠ” ë¸”ë¡œê·¸ì™€ Q&A ì½˜í…ì¸ ë¥¼, CoachingUsëŠ” ì½”ì¹­ê³¼ ì¹¼ëŸ¼ ì½˜í…ì¸ ë¥¼ ìƒì‚°ê³¼ ì†Œë¹„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì½˜í…ì¸ ë¥¼ ìƒì‚°í•˜ëŠ” UsëŠ” ì ìˆ˜ë¥¼ íšë“í•  ìˆ˜ ìˆê³ , ì½˜í…ì¸ ë¥¼ ì†Œë¹„í•˜ëŠ” UsëŠ” ì ìˆ˜ë¥¼ ì¤„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ë§Œì¼, ë¸”ë¡œê·¸ì—ì„œ ê³µë¶€í•œ ë‚´ìš©ì„ ì‘ì„±í•œë‹¤ë©´ ì‘ì„±ì— ëŒ€í•œ ë³´ìƒìœ¼ë¡œ ì ìˆ˜ë¥¼ íšë“í•  ê²ƒì…ë‹ˆë‹¤. ì´í›„ì—ëŠ” ëˆ„êµ°ê°€ì—ê²ŒëŠ” ë„ì›€ì´ ë˜ëŠ” ê¸€, í˜¹ì€ ì˜ëª»ëœ ì •ë³´ë¥¼ ì „ë‹¬í•˜ëŠ” ê¸€ì´ ë  ê²ƒì…ë‹ˆë‹¤. ì´ëŠ” ì½˜í…ì¸ ë¥¼ ì†Œë¹„í•˜ëŠ” ì‚¬ëŒë“¤ì´ ì •í•˜ë©° ğŸ‘Â ì¢‹ì•„ìš”ì™€ ğŸ‘Â ì‹«ì–´ìš” ë¡œ ì§€ì†ì ìœ¼ë¡œ ì ìˆ˜ê°€ ë³€ë™ë  ê²ƒì…ë‹ˆë‹¤. ì´ëŠ” ë¸”ë¡œê·¸ ì™¸ Q&A, ì½”ì¹­ê³¼ ì¹¼ëŸ¼ ëª¨ë‘ ë™ì¼í•˜ê²Œ ì ìš©ë©ë‹ˆë‹¤. ë³¸ì¸ì˜ í™œë™ì— ì ìˆ˜ë¼ëŠ” ì§€í‘œë¡œ ì§€ì†ì ì¸ í”¼ë“œë°±ì„ ë°›ì•„ ì˜ í•˜ê³  ìˆëŠ”ì§€ë¥¼ íŒŒì•…í•  ìˆ˜ ìˆê²Œ ë©ë‹ˆë‹¤.

ì´í›„ì˜ CoachingUsì—ì„œëŠ” ê°œë°œìë¡œì˜ ì‹œì‘, ì „í™˜ì„ ìœ„í•œ ì·¨ì—… ì§€ì› ì½˜í…ì¸ ë¥¼ ì œê³µí•©ë‹ˆë‹¤. CodingUsì—ì„œëŠ” UsYouthì™€ UsCoachì˜ í™œë™ ì˜ì—­ì´ ë™ì¼í•˜ë‚˜ CoachingUsì—ì„œëŠ” ë‹¬ë¼ì§‘ë‹ˆë‹¤. UsMemberëŠ” ê²°ì œí•˜ì—¬ ë³¸ì¸ì˜ ìê¸°ì†Œê°œì„œë‚˜ í¬íŠ¸í´ë¦¬ì˜¤ ë“± ì·¨ì—… ì½”ì¹­ì„ ì‹ ì²­í•˜ë©° UsCoachëŠ” ì½”ì¹­ì„ ì§„í–‰í•˜ë©° ëŒ€ê°€ë¥¼ ë°›ìŠµë‹ˆë‹¤. ì¹¼ëŸ¼ì€ ì½”ì¹˜ê°€ ì¬ëŸ‰ìœ¼ë¡œ ì‘ì„±í•˜ëŠ” ê¸€ë¡œ, UsMemberì˜ ë¸”ë¡œê·¸ë³´ë‹¤ ì¡°ê¸ˆ ë” ì „ë¬¸ì ì¸ ì¸ì‚¬ì´íŠ¸ë¥¼ ì–»ì„ ìˆ˜ ìˆìœ¼ë©° UsCoach ë³¸ì¸ì„ PRí•  ìˆ˜ ìˆëŠ” ì½˜í…ì¸ ì…ë‹ˆë‹¤.



### 2.ì‚¬ìš©ê¸°ìˆ  ìŠ¤íƒ

---
javascript, typescript

node, nestjs, typeorm, graphql

elasticsearch,logstash

mysql, redis

docker, git, discord, notion, github


### 3.DATA íë¦„ë„

---
![](/teamproject/backend/img/pipe.png)
### 4.DATA FLOW

---
![](/teamproject/backend/img/flow.png)

### 5.ERD

---
![](/teamproject/backend/img/erd.png)

### 6.api ëª…ì„¸ì„œ

---
![]()

### 7.api

---
#### Sing up

íšŒì›ê°€ì… ì •ë³´ë¥¼ ë°›ì€ í›„ ë¹„ë°€ë²ˆí˜¸ëŠ” bycrypt ë¥¼ ì‚¬ìš©í•˜ì—¬ hashí•˜ì—¬ ì €ì¥


`const hashedPassword = await bcrypt.hash(password, 10);`

íœ´ëŒ€í° ì¸ì¦ì„ ìœ„í•´ì„œ NHN Cloud Serviceë¥¼ ì‚¬ìš©.
6ìë¦¬ì˜ ëœë¤ ë²ˆí˜¸ë¥¼ ìƒì„±í•˜ê³  íœ´ëŒ€ì „í™”ë²ˆí˜¸ì— ì „ì†¡ì„ í•˜ê²Œë©ë‹ˆë‹¤.
ì¸ì¦í™•ì¸ì„ ìœ„í•´ redis ì— ì €ì¥ì„ í•˜ê³ , ì•„ì§ ì‹œê°„ì´ ë‚¨ì€ ì¸ì¦ë²ˆí˜¸ì¼ ê²½ìš° ì‚­ì œ í›„ ë‹¤ì‹œ ë³´ë‚´ê²Œ ë©ë‹ˆë‹¤.
í‚¤-ê°’ ì„ íœ´ëŒ€ì „í™”ë²ˆí˜¸-í† í°ë²ˆí˜¸ë¡œ redisì— ì €ì¥ì„ í•˜ì˜€ìŠµë‹ˆë‹¤.
```ts
const token = String(Math.floor(Math.random() * 10 ** 6)).padStart(6, '0');

    const appKeys = process.env.SMS_APP_KEY;
    const XSecretKey = process.env.SMS_X_SECRET_KEY;
    const sender = phonenumber;
    await axios.post(
      `https://api-sms.cloud.toast.com/sms/v3.0/appKeys/${appKeys}/sender/sms`,
      {
        body: `ì•ˆë…•í•˜ì„¸ìš”. ì¸ì¦ë²ˆí˜¸ëŠ” ${token}ì…ë‹ˆë‹¤`,
        sendNo: '01065474238',
        recipientList: [
          {
            internationalRecipientNo: sender,
          },
        ],
      },
      {
        headers: {
          'X-Secret-Key': XSecretKey,
          'Content-Type': 'application/json;charset=UTF-8',
        },
      },
    );
    const redistoken = await this.cacheManager.get(phonenumber);
    if (redistoken) await this.cacheManager.del(phonenumber);
    await this.cacheManager.set(phonenumber, token, {
      ttl: 180,
    });
    return `${phonenumber} ìœ¼ë¡œ ${token}ì„ ì „ì†¡í–ˆìŠµë‹ˆë‹¤`;
```

![](/teamproject/backend/img/nhn.jpeg)

ê¸°ì¡´ì— ì €ì¥ë˜ì–´ ìˆëŠ”ì§€ íœ´ëŒ€ë²ˆí˜¸ë¡œ ì¸ì¦ë²ˆí˜¸ë¥¼ í™•ì¸.
Booleanê°’ìœ¼ë¡œ ë¦¬í„´.
```ts
    const redistoken = await this.cacheManager.get(phonenumber);

    if (redistoken === token) {
      await this.cacheManager.del(phonenumber);
      return true;
    }
    return false;
```

ì¸ì¦ë²ˆí˜¸ê°€ ë§ë‹¤ë©´ trueê°’ì„ ë°˜í™˜, í‹€ë¦¬ê±°ë‚˜ 3ë¶„ì´ ì§€ë‚¬ë‹¤ë©´ falseë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
```ts
{
  "data": {
    "checktoken": true
  }
}
```
ì¸ì¦ì´ ëë‚œ í›„ íšŒì›ê°€ì…ì´ ë©ë‹ˆë‹¤.

#### Login

bycrypt compareë¡œ ë¹„ë°€ë²ˆí˜¸ë¥¼ í™•ì¸
í‹€ë¦´ê²½ìš° UnauthorizedExceptionë¡œ 401ì—ëŸ¬ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
```ts
    const isAuthenticated = await bcrypt.compare(password, user.password); //user.password - í•´ì‰¬ëœ ë¹„ë°€ë²ˆí˜¸
    if (!isAuthenticated)
      throw new UnauthorizedException('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤!!!');

```

ë¡œê·¸ì¸ì´ ë˜ë©´ JWTë¥¼ ì´ìš©í•˜ì—¬ AccessToken, RefreshTokenì„ ë°œê¸‰í•©ë‹ˆë‹¤
accesstoken ì„ ë°˜í™˜í•´ì£¼ê³ 
```ts
{
  "data": {
    "login": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJlbWFpbCI6IjEiLCJzdWIiOiI5NjdjOTNmOS0xNjNiLTQ4Y2MtYTAyYS02ZDE2ZWFhNTFiZjEiLCJyb2xlIjoiVVNFUiIsImlhdCI6MTY1NjY2MzAxOCwiZXhwIjoxNjU2NjcwMjE4fQ._fG6eIGy9HxBgcMg5UrQVm-PTEgKbwk8JnwiUoKfffQ"
  }
}
```
refreshtoken ì€ Access-Control-Allow-Origin ì˜µì…˜ì„ ì‚¬ìš©í•´ì„œ 
headerì— ë‹´ì•„ì„œ ì „ì†¡í•©ë‹ˆë‹¤.
```ts
   res.setHeader(
      'Set-Cookie',
      `refreshToken=${refreshToken}; path=/;domain=.cucutoo.com; SameSite=None; Secure; httpOnly;`,
    );
```
![](/teamproject/backend/img/cookie.png)


#### logout
ë¡œê·¸ì•„ì›ƒì„ í•˜ë©´ redisì— accesstoken ê³¼ refreshtokenê°’ì„ ì €ì¥í•˜ì—¬ 
ë¡œê·¸ì¸ í•œ í† í°ì´ ë‹¤ì‹œ ì‚¬ìš©ë˜ì—ˆì„ ë•Œ validate ì—ì„œ ê²€ì¦ì„ í•˜ë„ë¡ êµ¬ì„±í–ˆìŠµë‹ˆë‹¤.

```ts
    await this.cacheManager.set(`accesstoken:${accesstoken}`, User, {
      ttl: User.exp,
    });
    return await this.cacheManager.set(`refreshToken:${refreshToken}`, User, {
      ttl: User.exp,
    });
```

```ts
async validate(req, payload) {
    const accesstoken = req.headers.authorization.replace('Bearer ', '');
    const check = await this.cacheManager.get(`accesstoken:${accesstoken}`);
    if (check) throw new UnauthorizedException('ì´ë¯¸ ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.');
    return {
      id: payload.sub,
      email: payload.email,
      role: payload.role,
      exp: payload.exp,
    };
  }
```
ë¡œê·¸ì•„ì›ƒëœ í† í°ì„ ë‹¤ì‹œ ë¡œê·¸ì•„ì›ƒ í•  ì‹œ ì—ëŸ¬ë°˜í™˜
```json
{
  "errors": [
    {
      "message": "ì´ë¯¸ ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.",
      "extensions": {
        "code": "UNAUTHENTICATED",
        "response": {
          "statusCode": 401,
          "message": "ì´ë¯¸ ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.",
          "error": "Unauthorized"
        }
      }
    }
  ],
  "data": null
}
```
#### search
ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥ë°›ì•„ elasticsearchë¥¼ ì‚¬ìš©í•˜ì—¬ ì—­ìƒ‰ì¸ ê²€ìƒ‰ì´ ë˜ë„ë¡ êµ¬ì„±í•˜ì˜€ìŠµë‹ˆë‹¤.
entity í˜•ì‹ì— ë§ì¶°ì„œ ê°’ì„ ë°˜í™˜í•˜ì˜€ìŠµë‹ˆë‹¤.

```ts
async fetchBlogSearch(@Args('search') search: string) {
    const result = await this.elasticsearchService.search({
      index: 'blog',
      query: {
        bool: {
          must: [{ match: { status: 'blog' } }],
          should: [
            { match_phrase: { title: search } }, //
            { match_phrase: { searchcontents: search } },
          ],
          minimum_should_match: 1,
        },
      },
    });

    if (!result.hits.hits.length) return [];
    //console.log(result.hits.hits)
    const resultmap = result.hits.hits.map((ele): any => {
      const temp = JSON.stringify(ele);
      const el = JSON.parse(temp);
      return {
        id: el._source.id,
        contents: el._source.contents,
        like: el._source.like,
        title: el._source.title,
        status: el._source.status,
        searchcontents: el._source.searchcontents,
        user: {
          email: el._source.email,
          nickname: el._source.nickname,
        },
        blogcategorytag: [
          {
            tag: el._source.tag,
          },
        ],
        updatedat: String(el._source.updatedat),
      };
    });
    return JSON.parse(JSON.stringify(resultmap));
  }
```

ë³¸ë¬¸ ë‚´ìš© ì „ì²´ë¥¼ mysqlì— ì €ì¥ì„ í•˜ê¸°ë•Œë¬¸ì—, êµ¬ë¶„ìì™€ ê°™ì€ ê²€ìƒ‰ì— ë¶ˆí•„ìš”í•œ ë‹¨ì–´ë“¤ì„ ì œê±°í•˜ê¸°ìœ„í•´ filterë¥¼ ì‚¬ìš©
filterì—ì„œëŠ” mutate ì˜µì…˜ ì¤‘ copy ë¥¼ ì‚¬ìš©í•˜ì—¬ searchcontentsë¥¼ ì¶”ê°€ í•œ í›„
ì •ê·œì‹ì„ ì‚¬ìš©í•˜ì—¬ ë³€í™˜í•  ìˆ˜ ìˆëŠ” gsub ì˜µì…˜ì„ ì‚¬ìš©.

``` json
filter {

    if [type] == "blog"{
        mutate {
            add_field => {
                "status" => "blog"
            }
        }
    } 
    mutate { 
        copy => {
            "contents" => "searchcontents"
        }
    }
    mutate { 
        gsub => [  
            "searchcontents","!\[\]+[(]+[0-9a-zA-Z:/]+[)]","",
            "searchcontents"," {3,}","  ",
            "searchcontents","\`","",
            "searchcontents","\#{2,}","",
            "searchcontents","/n","",
            "searchcontents","http[0-9a-zA-Z:/.!?<>()]+[ ]",""
        ]
    }
}
```

document_id => "%{id}" ì˜µì…˜ì„ ì‚¬ìš©í•´ì„œ ìˆ˜ì •í–ˆì„ ë•Œ ê°™ì€ idê°’ì´ ì¤‘ë³µë˜ì§€ ì•Šë„ë¡ ì„¤ì •
templateë¥¼ í•˜ê¸° ìœ„í•´ì„œ template ê´€ë ¨ ì˜µì…˜ë“¤ì„ ì‚¬ìš©
```json
output {
    if [type] == "blog" {
        elasticsearch {
            hosts => "elasticsearch:9200"
            index => "blog"
            document_id => "%{id}"
            manage_template => true 
            template_name => "cu"
            template => "/_templates/cu/template.json"
            template_overwrite => true
        }
            stdout { codec => rubydebug }
    }
}
```
stdout ì˜µì…˜ì„ ì‚¬ìš©í•˜ì—¬ ì•„ë˜ì™€ ê°™ì´ elasticsearchì— ì˜¬ë¼ê°€ëŠ” ë°ì´í„°ë¥¼ logë¡œ í™•ì¸ ê°€ëŠ¥
contents ì— ìˆëŠ” êµ¬ë¶„ìë¥¼ searchcontentsì—ì„œëŠ” ì œì™¸í•˜ê³  ì €ì¥ë˜ëŠ”ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŒ.

```json
 {
               "like" => 0,
               "type" => "blog",
     "searchcontents" => "ê²€ìƒ‰ í…ŒìŠ¤íŠ¸ ",
         "@timestamp" => 2022-07-01T09:18:00.468Z,
          "updatedat" => 1656667038.135285,
           "nickname" => "6",
                 "id" => "aaaf911f-9fc0-4c7c-ad4e-668aaa695153",
              "title" => "ê²€ìƒ‰í…ŒìŠ¤íŠ¸",
             "status" => "blog",
                "tag" => "JS",
           "contents" => "ê²€ìƒ‰ í…ŒìŠ¤íŠ¸ ![](Https://test)",
           "@version" => "1",
              "email" => "1"
 }
```

tokennizerë¥¼ ngramì„ ì‚¬ìš©í•´ì„œ í¬í•¨ëœ ë‹¨ì–´ë„ ê²€ìƒ‰ ê°€ëŠ¥
```json
query
{
  fetchBlogSearch(search:"í…ŒìŠ¤"){
    searchcontents
    title
  }
}
```

```json
{
  "data": {
    "fetchBlogSearch": [
      {
        "searchcontents": "ê²€ìƒ‰ í…ŒìŠ¤íŠ¸ ",
        "title": "ê²€ìƒ‰í…ŒìŠ¤íŠ¸"
      },
      {
        "searchcontents": "ê²€ìƒ‰ í…ŒìŠ¤íŠ¸",
        "title": "search"
      }
    ]
  }
}
```

